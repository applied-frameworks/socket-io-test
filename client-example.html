<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Realtime Canvas - Test Client</title>
  <script src="https://cdn.socket.io/4.6.1/socket.io.min.js"></script>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
      background: #f5f5f5;
    }

    .container {
      max-width: 1200px;
      margin: 0 auto;
      padding: 20px;
    }

    .auth-section {
      background: white;
      padding: 30px;
      border-radius: 8px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
      margin-bottom: 20px;
    }

    .auth-section.hidden {
      display: none;
    }

    h1 {
      margin-bottom: 20px;
      color: #333;
    }

    .form-group {
      margin-bottom: 15px;
    }

    label {
      display: block;
      margin-bottom: 5px;
      color: #555;
      font-weight: 500;
    }

    input {
      width: 100%;
      padding: 10px;
      border: 1px solid #ddd;
      border-radius: 4px;
      font-size: 14px;
    }

    button {
      padding: 10px 20px;
      background: #007bff;
      color: white;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      font-size: 14px;
      margin-right: 10px;
    }

    button:hover {
      background: #0056b3;
    }

    button.secondary {
      background: #6c757d;
    }

    button.secondary:hover {
      background: #545b62;
    }

    .canvas-section {
      display: none;
      background: white;
      padding: 20px;
      border-radius: 8px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }

    .canvas-section.active {
      display: block;
    }

    .toolbar {
      display: flex;
      gap: 10px;
      margin-bottom: 15px;
      padding: 15px;
      background: #f8f9fa;
      border-radius: 4px;
      flex-wrap: wrap;
      align-items: center;
    }

    #canvas {
      border: 2px solid #ddd;
      cursor: crosshair;
      display: block;
      background: white;
    }

    .status {
      padding: 10px;
      margin-bottom: 15px;
      border-radius: 4px;
      background: #d4edda;
      color: #155724;
      border: 1px solid #c3e6cb;
    }

    .users-list {
      margin-top: 15px;
      padding: 15px;
      background: #f8f9fa;
      border-radius: 4px;
    }

    .user-item {
      padding: 5px;
      color: #555;
    }

    .error {
      background: #f8d7da;
      color: #721c24;
      border: 1px solid #f5c6cb;
    }

    .color-picker {
      width: 50px;
      height: 40px;
      border: none;
      cursor: pointer;
    }

    .tool-group {
      display: flex;
      gap: 5px;
      align-items: center;
    }

    .tool-label {
      color: #555;
      font-size: 14px;
      font-weight: 500;
    }
  </style>
</head>
<body>
  <div class="container">
    <!-- Authentication Section -->
    <div id="authSection" class="auth-section">
      <h1>Realtime Collaborative Canvas</h1>
      
      <div id="loginForm">
        <h2>Login</h2>
        <div class="form-group">
          <label for="loginUsername">Username</label>
          <input type="text" id="loginUsername" placeholder="Enter username">
        </div>
        <div class="form-group">
          <label for="loginPassword">Password</label>
          <input type="password" id="loginPassword" placeholder="Enter password">
        </div>
        <button onclick="login()">Login</button>
        <button class="secondary" onclick="showRegister()">Register</button>
      </div>

      <div id="registerForm" style="display: none;">
        <h2>Register</h2>
        <div class="form-group">
          <label for="registerUsername">Username</label>
          <input type="text" id="registerUsername" placeholder="Choose username">
        </div>
        <div class="form-group">
          <label for="registerEmail">Email (optional)</label>
          <input type="email" id="registerEmail" placeholder="Enter email">
        </div>
        <div class="form-group">
          <label for="registerPassword">Password</label>
          <input type="password" id="registerPassword" placeholder="Choose password">
        </div>
        <button onclick="register()">Register</button>
        <button class="secondary" onclick="showLogin()">Back to Login</button>
      </div>

      <div id="authMessage"></div>
    </div>

    <!-- Canvas Section -->
    <div id="canvasSection" class="canvas-section">
      <div id="statusMessage" class="status"></div>
      
      <div class="toolbar">
        <div class="tool-group">
          <span class="tool-label">Color:</span>
          <input type="color" id="colorPicker" class="color-picker" value="#000000">
        </div>
        
        <div class="tool-group">
          <span class="tool-label">Size:</span>
          <input type="range" id="brushSize" min="1" max="20" value="2">
          <span id="sizeValue">2</span>
        </div>
        
        <button onclick="clearCanvas()">Clear Canvas</button>
        <button class="secondary" onclick="logout()">Logout</button>
      </div>

      <canvas id="canvas" width="1000" height="600"></canvas>

      <div class="users-list">
        <h3>Active Users</h3>
        <div id="usersList"></div>
      </div>
    </div>
  </div>

  <script>
    // Configuration - UPDATE THIS WITH YOUR BACKEND URL
    const BACKEND_URL = 'http://localhost:3000';
    
    let socket = null;
    let token = null;
    let canvas = null;
    let ctx = null;
    let isDrawing = false;
    let currentUser = null;

    // Initialize canvas
    function initCanvas() {
      canvas = document.getElementById('canvas');
      ctx = canvas.getContext('2d');
      
      canvas.addEventListener('mousedown', startDrawing);
      canvas.addEventListener('mousemove', draw);
      canvas.addEventListener('mouseup', stopDrawing);
      canvas.addEventListener('mouseout', stopDrawing);

      // Update brush size display
      document.getElementById('brushSize').addEventListener('input', (e) => {
        document.getElementById('sizeValue').textContent = e.target.value;
      });
    }

    // Authentication functions
    function showRegister() {
      document.getElementById('loginForm').style.display = 'none';
      document.getElementById('registerForm').style.display = 'block';
    }

    function showLogin() {
      document.getElementById('registerForm').style.display = 'none';
      document.getElementById('loginForm').style.display = 'block';
    }

    async function register() {
      const username = document.getElementById('registerUsername').value;
      const email = document.getElementById('registerEmail').value;
      const password = document.getElementById('registerPassword').value;

      try {
        const response = await fetch(`${BACKEND_URL}/api/auth/register`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ username, email, password })
        });

        const data = await response.json();

        if (response.ok) {
          showMessage('Registration successful! Logging in...', 'success');
          token = data.token;
          currentUser = data.user;
          localStorage.setItem('token', token);
          connectSocket();
        } else {
          showMessage(data.error, 'error');
        }
      } catch (error) {
        showMessage('Connection error: ' + error.message, 'error');
      }
    }

    async function login() {
      const username = document.getElementById('loginUsername').value;
      const password = document.getElementById('loginPassword').value;

      try {
        const response = await fetch(`${BACKEND_URL}/api/auth/login`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ username, password })
        });

        const data = await response.json();

        if (response.ok) {
          showMessage('Login successful!', 'success');
          token = data.token;
          currentUser = data.user;
          localStorage.setItem('token', token);
          connectSocket();
        } else {
          showMessage(data.error, 'error');
        }
      } catch (error) {
        showMessage('Connection error: ' + error.message, 'error');
      }
    }

    function logout() {
      if (socket) {
        socket.disconnect();
      }
      token = null;
      currentUser = null;
      localStorage.removeItem('token');
      document.getElementById('authSection').classList.remove('hidden');
      document.getElementById('canvasSection').classList.remove('active');
      showMessage('Logged out successfully', 'success');
    }

    function showMessage(message, type) {
      const authMessage = document.getElementById('authMessage');
      authMessage.textContent = message;
      authMessage.className = type === 'error' ? 'status error' : 'status';
      authMessage.style.display = 'block';
      authMessage.style.marginTop = '15px';
    }

    // Socket.IO functions
    function connectSocket() {
      socket = io(BACKEND_URL, {
        auth: { token }
      });

      socket.on('connect', () => {
        console.log('Connected to server');
      });

      socket.on('user:connected', (data) => {
        document.getElementById('authSection').classList.add('hidden');
        document.getElementById('canvasSection').classList.add('active');
        document.getElementById('statusMessage').textContent = 
          `Connected as ${data.username}`;
        
        // Join default canvas room
        socket.emit('canvas:join', 'default-canvas');
        initCanvas();
      });

      socket.on('canvas:state', (state) => {
        console.log('Received canvas state:', state);
        // TODO: Render existing shapes
      });

      socket.on('canvas:users', (users) => {
        updateUsersList(users);
      });

      socket.on('user:joined', (user) => {
        console.log('User joined:', user.username);
      });

      socket.on('draw:start', (data) => {
        // Another user started drawing
        drawPoint(data.x, data.y, data.color, data.width);
      });

      socket.on('draw:move', (data) => {
        // Another user is drawing
        drawPoint(data.x, data.y);
      });

      socket.on('canvas:clear', () => {
        ctx.clearRect(0, 0, canvas.width, canvas.height);
      });

      socket.on('connect_error', (error) => {
        console.error('Connection error:', error);
        showMessage('Connection failed: ' + error.message, 'error');
      });
    }

    // Drawing functions
    function startDrawing(e) {
      isDrawing = true;
      const rect = canvas.getBoundingClientRect();
      const x = e.clientX - rect.left;
      const y = e.clientY - rect.top;
      const color = document.getElementById('colorPicker').value;
      const width = document.getElementById('brushSize').value;

      socket.emit('draw:start', { x, y, color, width });
      drawPoint(x, y, color, width);
    }

    function draw(e) {
      if (!isDrawing) return;

      const rect = canvas.getBoundingClientRect();
      const x = e.clientX - rect.left;
      const y = e.clientY - rect.top;

      socket.emit('draw:move', { x, y });
      drawPoint(x, y);
    }

    function stopDrawing() {
      if (!isDrawing) return;
      isDrawing = false;
      socket.emit('draw:end', {});
    }

    function drawPoint(x, y, color, width) {
      ctx.fillStyle = color || document.getElementById('colorPicker').value;
      const size = width || document.getElementById('brushSize').value;
      ctx.fillRect(x - size/2, y - size/2, size, size);
    }

    function clearCanvas() {
      socket.emit('canvas:clear');
      ctx.clearRect(0, 0, canvas.width, canvas.height);
    }

    function updateUsersList(users) {
      const usersList = document.getElementById('usersList');
      usersList.innerHTML = users.map(user => 
        `<div class="user-item">ðŸ‘¤ ${user.username}</div>`
      ).join('');
    }

    // Check for existing token on page load
    window.onload = () => {
      const savedToken = localStorage.getItem('token');
      if (savedToken) {
        token = savedToken;
        connectSocket();
      }
    };
  </script>
</body>
</html>
